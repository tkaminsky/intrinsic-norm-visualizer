import*as f from"https://unpkg.com/three@0.160.0?module";import{GUI as It}from"https://cdn.skypack.dev/lil-gui@0.18.0";import At from"https://cdn.skypack.dev/delaunator@5.0.0";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();function Ft(){const t=document.createElement("div");t.id="helpLayer",t.innerHTML=`
      <style>
        #helpLayer        { position:fixed; inset:0;
                            background:rgba(0,0,0,.55);
                            display:flex; align-items:center; justify-content:center;
                            z-index:10000; }                /* sits on top */
        #helpBox          { width:min(800px, 90%);
                            max-height:80%; overflow:auto;
                            background:#fff; padding:28px 32px;
                            border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,.4);
                            font:16px/1.5 sans-serif; position:relative; }
  
        #helpClose        { position:absolute; left:14px; top:14px;
                            font:24px/24px sans-serif; cursor:pointer;
                            border:none; background:none; }
        #helpToggle       { position:fixed; right:18px; bottom:18px;
                            width:38px; height:38px; border-radius:50%;
                            border:none; background:#222; color:#fff; font:24px/38px sans-serif;
                            cursor:pointer; z-index:9999; }
      </style>
  
      <div id="helpBox">
          <button id="helpClose" title="Close">&times;</button>
  
          <h2 style="margin-top:0">Intrinsic Norm Visualizer</h2>

          <p>Hello, and welcome! This is a tool for visualizing <a href="https://www.mit.edu/~gfarina/2024/67220s24_L14B_self_concordance/L14.pdf" target="_blank">intrinsic norms</a> in the domains of some functions. There are a few ways to select/construct functions. Selecting a point on a manifold will transform it so all points have euclidean norm equal to the corresponding intrinsic norm (in the x-y plane). Hopefully, this can help you 'see' what the function looks like from the persective of the intrinsic norm!</p>

          <p>
          <strong>Choosing Functions</strong><br>
          <strong>Preset Functions</strong>: Click any of the buttons to load a pre-defined function.<br>
          <strong>Polygon Barrier</strong>: Create a polygon by selecting a sequence of points in the 2D grid in the top-left corner. Click the first vertex a second time to complete the polygon.<br>
          <strong>Removing Polygons</strong>: Click anywhere inside the interior of a polygon to remove it. </p>
        <p style="color:red;">
            <strong>Warning</strong>: If a polygon's barrier is strictly positive, it may not be visualized successfully. varying the <strong>max height</strong> parameter may help, but if its minimum is above the max height you might just have to try a different polygon. 
        </p>

        <p><strong>Functionality</strong><br>
                <strong>Hover</strong> over the surface to see the intrinic unit ball at that point.<br>
                <strong>Click</strong> to transform space to reflect that point's intrinsic norm.<br>
                <strong>Click Again</strong> revert to the global euclidean norm.<br>
          </p>

          <p><strong>Camera Controls</strong><br><strong>Rotate Z</strong>: Rotate the camera about the z-axis.<br>
             <strong>Zoom</strong>: Zoom view in/out.<br>
             <strong>Altitude</strong>: Change viewing height.</p>

             <p> Please feel free to reach me <a href="mailto:tkaminsky@g.harvard.edu">by email</a> with any questions, comments, or suggestions. I just learned about this, so it's very possible that I've made some mistakes, either conceptually or with the code. I look forward to any feedback you have! <br><br>
             ––Thomas
             </p>
  
          
  
          <p style="margin-bottom:0; font-size:90%; color:#555">
             (You can reopen these instructions later by clicking the “?” button.)</p>
      </div>
    `;const e=document.createElement("button");e.id="helpToggle",e.textContent="?",e.title="Show instructions",e.style.cssText=`
    position:fixed; right:18px; bottom:18px;
    width:38px; height:38px; border-radius:50%;
    border:none; background:#222; color:#fff;
    font:24px/38px sans-serif; cursor:pointer;
    z-index:9999;
    `;function o(){document.body.appendChild(t)}function r(){t.remove()}t.querySelector("#helpClose").onclick=r,e.onclick=o,document.body.appendChild(e),o()}Ft();const v={xMin:-5,xMax:5,yMin:-5,yMax:5,samples:100,rotationZ:0,zoom:15,altitude:20,capZ:-1},M=[];let z,k,gt,xt,W=!1,C=[],G=null,P=null,N=!0;const H=new f.Scene;H.add(new f.AmbientLight(16777215,.8));H.add(new f.HemisphereLight(16777215,4473924,.9));const wt=new f.DirectionalLight(16777215,1.1);wt.position.set(3,4,6);H.add(wt);H.background=new f.Color(16777215);const I=new f.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3);I.up.set(0,0,1);const R=new f.WebGLRenderer({antialias:!0});R.setSize(window.innerWidth,window.innerHeight);document.body.appendChild(R.domElement);const A=document.createElement("div");A.id="overlayBox";A.style.transformOrigin="50% 50%";document.body.appendChild(A);const w=document.createElement("canvas");w.style.width="100%";w.style.height="100%";A.appendChild(w);const d=w.getContext("2d");ft();function at(){A.style.transform=`rotate(${v.rotationZ}rad)`}function St(t){const e=A.getBoundingClientRect(),o=e.left+e.width*.5,r=e.top+e.height*.5,n=t.clientX-o,i=t.clientY-r,s=Math.sin(-v.rotationZ),a=Math.cos(-v.rotationZ),u=n*a-i*s,y=n*s+i*a;return{px:u+w.width*.5,py:y+w.height*.5}}const m={active:!1,back:!1,duration:1,startTime:0,startPos:null,endPos:null,polys:[],ball:null},J=[{label:"Radial Bowl",fn:(t,e)=>Math.sqrt(t*t+e*e+1)-1,tex:"\\sqrt{x^{2}+y^{2}+1}\\;{-}\\;1"},{label:"Log Barrier",fn:(t,e)=>-Math.log(5.001-t)-Math.log(5.001-e),tex:"-\\log(5{-}x)\\;{-}\\;\\log(5{-}y)"},{label:"Paraboloid",fn:(t,e)=>.125*(t*t+e*e),tex:"\\frac18\\bigl(x^{2}+y^{2}\\bigr)"},{label:"Tilted Quadratic",fn:(t,e)=>(6*t*t+t*e+2*e*e)/20,tex:"\\tfrac1{20}\\bigl(6x^{2}+xy+2y^{2}\\bigr)"},{label:"LogSumExp",fn:(t,e)=>2*Math.log(Math.exp(.3*t)+Math.exp(.3*e)+Math.exp(-.3*(t+e))),tex:"2\\,\\log\\!\\bigl(e^{0.3x}+e^{0.3y}+e^{-0.3(x+y)}\\bigr)"},{label:"Sine × Cos",fn:(t,e)=>Math.sin(t)*Math.cos(e),tex:"\\sin x\\,\\cos y"}],vt=document.getElementById("funcBar");J.forEach(({label:t},e)=>{const o=document.createElement("button");o.textContent=t,o.className="preset-btn",e===0&&o.classList.add("active"),o.onclick=()=>Vt(e),o.onmouseenter=async()=>{$.innerHTML=`\\[ ${J[e].tex} \\]`,await MathJax.typesetPromise([$]),Y.style.opacity=1},o.onmouseleave=()=>{Y.style.opacity=0},vt.appendChild(o)});const Y=document.createElement("div");Y.style.cssText=`
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  pointer-events:none;                /* ignore clicks */
  opacity:0; transition:opacity .18s ease;
  z-index:9998;
`;const $=document.createElement("div");$.style.cssText=`
  background:rgba(255,255,255,.85);
  padding:14px 18px; border-radius:12px;
  box-shadow:0 4px 18px rgba(0,0,0,.25);
  font-size:22px;                      /* MathJax ignores but fixes flash */
`;Y.appendChild($);document.body.appendChild(Y);function Vt(t){Z=J[t].fn,_t(),st(),D(),[...vt.children].forEach((e,o)=>e.classList.toggle("active",o===t)),st(),D()}const Q=new It({width:300});function Mt(){const t=Math.min(300,Math.max(180,window.innerWidth*.22));Q.domElement.style.width=t+"px"}Mt();window.addEventListener("resize",Mt);const ct=Q.addFolder("Camera"),Gt=Q.add(v,"rotationZ",-Math.PI,Math.PI,.01).name("Rotate Z");at();Gt.onChange(()=>{_(),at()});ct.add(v,"zoom",1,100,.1).name("Zoom").onChange(_);ct.add(v,"altitude",.1,100,.1).name("Altitude").onChange(_);ct.open();Q.add(v,"capZ",-10,10,.1).name("Max Height").onChange(D);const Pt=J[0].fn;let Z=Pt;const K=new f.Raycaster,j=new f.Vector2;let B=!1,X=null;const E=new f.Mesh(new f.SphereGeometry(.1,16,16),new f.MeshBasicMaterial({color:16711680})),S=E.clone();S.visible=!1;function st(){B&&(G=null,P=null,X&&X.dispose()),B=!1,X=null,S.visible=!1,E.visible=!0}function U(t,e,o){const r=t.x-e.x,n=t.y-e.y,i=o.L11*r+o.L12*n,s=o.L12*r+o.L22*n;return!Number.isFinite(i)||!Number.isFinite(s)?new f.Vector3(t.x,t.y,t.z):new f.Vector3(e.x+i,e.y+s,t.z)}function Ct(t,e,o,r=64){const n=[];for(let i=0;i<r;++i){const s=2*Math.PI*i/r,a=Math.cos(s),u=Math.sin(s),y=a*(o.a11*a+o.a12*u)+u*(o.a12*a+o.a22*u);if(y<=0)continue;const l=1/Math.sqrt(y);n.push({x:t+l*a,y:e+l*u})}return n}function Ht(t,e,o=!1){const r=t.getAttribute("position"),n=r.count;let i=1/0,s=-1/0;for(let l=0;l<n;++l){const h=r.getZ(l);h<i&&(i=h),h>s&&(s=h)}const a=e.map(l=>new f.Color(l)),u=new Float32Array(n*3),y=new f.Color;for(let l=0;l<n;++l){let h=(r.getZ(l)-i)/(s-i||1);o&&(h=1-h);const p=h*(a.length-1),g=Math.floor(p),c=Math.min(g+1,a.length-1),x=p-g;y.copy(a[g]).lerp(a[c],x),u[3*l]=y.r,u[3*l+1]=y.g,u[3*l+2]=y.b}t.setAttribute("color",new f.BufferAttribute(u,3))}const Zt=["#fde725","#7ad151","#21a585","#2a788e","#414487","#440154"];function F(t,e){const{xMin:o,xMax:r,yMin:n,yMax:i}=v,s=(t-o)/(r-o)*w.width,a=w.height-(e-n)/(i-n)*w.height;return{px:s,py:a}}function qt(t,e){const{xMin:o,xMax:r,yMin:n,yMax:i}=v,s=t/w.width*(r-o)+o,a=(w.height-e)/w.height*(i-n)+n;return{x:s,y:a}}function Nt(t,e){const o=t.px-e.px,r=t.py-e.py;return o*o+r*r}function jt(t){const e=[],o=t.length;for(let r=0;r<o;r++){const n=t[r],i=t[(r+1)%o],s=i.x-n.x,u={x:-(i.y-n.y),y:s},y=u.x*n.x+u.y*n.y;e.push({n:u,c:y})}return e}function Ot(t,e){M.forEach(o=>{if(!o.mesh)return;const r=o.mesh.geometry,n=r.getAttribute("position"),i=n.array;for(let s=0;s<i.length;s+=3){const a=new f.Vector3(i[s],i[s+1],i[s+2]),u=U(a,t,e);i[s]=u.x,i[s+1]=u.y}n.needsUpdate=!0,r.computeVertexNormals()})}const O=[];function bt(){return O.length?(t,e)=>{let o=0;for(const{n:r,c:n}of O){const i=r.x*t+r.y*e-n;if(i<=0)return NaN;o+=Math.log(i)}return-o}:Pt}function lt(t,e){let o=!1;for(let r=0,n=e.length-1;r<e.length;n=r++){const i=e[r].x,s=e[r].y,a=e[n].x,u=e[n].y;s>t.y!=u>t.y&&t.x<(a-i)*(t.y-s)/(u-s)+i&&(o=!o)}return o}function Dt(t,e,o={}){const{step:r=.005,maxZ:n=1/0}=o;if(!(e!=null&&e.length))return new f.BufferGeometry;let i=1/0,s=1/0,a=-1/0,u=-1/0;for(const c of e)c.x<i&&(i=c.x),c.x>a&&(a=c.x),c.y<s&&(s=c.y),c.y>u&&(u=c.y);const y=[];for(let c=i;c<=a;c+=r)for(let x=s;x<=u;x+=r)if(lt({x:c,y:x},e)){let b=t(c,x);if(!Number.isFinite(b)||b>n)continue;y.push({x:c,y:x,z:b})}for(const{x:c,y:x}of e){let b=t(c,x);(!Number.isFinite(b)||b>n)&&(b=n),y.push({x:c,y:x,z:b})}if(y.length<3)return new f.BufferGeometry;const l=At.from(y,c=>c.x,c=>c.y),h=[];for(let c=0;c<l.triangles.length;c+=3)h.push(l.triangles[c],l.triangles[c+1],l.triangles[c+2]);const p=new Float32Array(y.length*3);y.forEach((c,x)=>{p[3*x]=c.x,p[3*x+1]=c.y,p[3*x+2]=c.z});const g=new f.BufferGeometry;return g.setAttribute("position",new f.BufferAttribute(p,3)),g.setIndex(h),g.computeVertexNormals(),g}function Rt(t,e,o,r,n){const i=(h,p)=>{if(!M.length)return!0;const g={x:h,y:p};return M.some(c=>lt(g,c.points))},s=new f.BufferGeometry,a=[],u=[],y=Array.from({length:n+1},()=>new Int32Array(n+1).fill(-1));let l=0;for(let h=0;h<=n;h++){const p=f.MathUtils.lerp(t,e,h/n);for(let g=0;g<=n;g++){const c=f.MathUtils.lerp(o,r,g/n);if(!i(p,c))continue;y[h][g]=l++;const x=Z(p,c);a.push(p,c,x)}}for(let h=0;h<n;h++)for(let p=0;p<n;p++){const g=y[h][p],c=y[h+1][p],x=y[h+1][p+1],b=y[h][p+1];g!==-1&&c!==-1&&b!==-1&&u.push(g,c,b),c!==-1&&x!==-1&&b!==-1&&u.push(c,x,b)}return s.setAttribute("position",new f.Float32BufferAttribute(a,3)),s.setIndex(u),s.computeVertexNormals(),s}function Ut(t=100,e=100){const o=new f.GridHelper(t,e,0,0);return o.rotation.x=Math.PI/2,o}function Wt(t=20){const e=new f.LineBasicMaterial({color:0}),o=new f.Group;return o.add(new f.Line(new f.BufferGeometry().setFromPoints([new f.Vector3(-t,0,0),new f.Vector3(t,0,0)]),e)),o.add(new f.Line(new f.BufferGeometry().setFromPoints([new f.Vector3(0,-t,0),new f.Vector3(0,t,0)]),e)),o.add(new f.Line(new f.BufferGeometry().setFromPoints([new f.Vector3(0,0,-t),new f.Vector3(0,0,t)]),e)),o}function Yt(t){return{mesh:null,halfspaces:jt(t)}}function _t(){for(const t of M)t.mesh&&z.remove(t.mesh);M.length=0,O.length=0,W=!1,C=[],E.visible=!1,S.visible=!1,N=!0,V()}function kt(t,e,o,r=1e-4){const n=t(e+r,o),i=t(e-r,o),s=t(e,o+r),a=t(e,o-r),u=t(e+r,o+r),y=t(e+r,o-r),l=t(e-r,o+r),h=t(e-r,o-r),p=(u-y-l+h)/(4*r*r),g=(n-2*t(e,o)+i)/(r*r),c=(s-2*t(e,o)+a)/(r*r),x=g,b=p,q=c,dt=x+q,ut=Math.sqrt((x-q)*(x-q)+4*b*b),ht=.5*(dt+ut),Lt=.5*(dt-ut);let L,T;Math.abs(b)>1e-20?(L=ht-q,T=b):x>=q?(L=1,T=0):(L=0,T=1);const pt=Math.hypot(L,T);L/=pt,T/=pt;const tt=-T,et=L,mt=1e-12,yt=1e12;let nt=ht,ot=Lt;nt=Math.min(Math.max(nt,mt),yt),ot=Math.min(Math.max(ot,mt),yt);const it=Math.sqrt(nt),rt=Math.sqrt(ot),Tt=it*L*L+rt*tt*tt,zt=it*L*T+rt*tt*et,Bt=it*T*T+rt*et*et;return{a11:x,a12:b,a22:q,L11:Tt,L12:zt,L22:Bt}}function Xt(t,e){const n=k.geometry.getAttribute("position").array.slice(),i=new Float32Array(n.length);for(let l=0;l<n.length;l+=3){const h=new f.Vector3(n[l],n[l+1],n[l+2]),p=U(h,t,e);i[l]=p.x,i[l+1]=p.y,i[l+2]=p.z}const s=M.map(l=>{const h=l.points.flatMap(g=>[g.x,g.y]),p=[];return l.points.forEach(({x:g,y:c})=>{const x=U(new f.Vector3(g,c,0),t,e);p.push(x.x,x.y)}),{poly:l,start:h,end:p}});m.overlay=s;const a=Ct(t.x,t.y,e,244),u=a.map(l=>{const h=U(new f.Vector3(l.x,l.y,0),t,e);return{x:h.x,y:h.y}});m.ball={start:Float32Array.from(a.flatMap(l=>[l.x,l.y])),end:Float32Array.from(u.flatMap(l=>[l.x,l.y]))},P=a.slice();const y=[];M.forEach(l=>{if(!l.mesh)return;const h=l.mesh.geometry.getAttribute("position"),p=h.array.slice(),g=new Float32Array(p.length);for(let c=0;c<p.length;c+=3){const x=new f.Vector3(p[c],p[c+1],p[c+2]),b=U(x,t,e);g[c]=b.x,g[c+1]=b.y,g[c+2]=b.z}y.push({attr:h,start:p,end:g})}),m.active=!0,m.back=!1,m.startTime=performance.now(),m.startPos=n,m.endPos=i,m.polys=y}function Jt(){z&&H.remove(z),z=new f.Object3D,H.add(z),gt=Ut(),xt=Wt(),z.add(gt,xt,E,S);const t=M.length===0?Rt(v.xMin,v.xMax,v.yMin,v.yMax,v.samples):Dt(Z,M[0].points,{step:.05,maxZ:v.capZ});Ht(t,Zt,!0),k=new f.Mesh(t,new f.MeshBasicMaterial({vertexColors:!0,side:f.DoubleSide})),z.add(k),M.forEach(e=>{e.mesh&&z.add(e.mesh)}),at()}function D(){st(),Jt(),V(),_()}function _(){const{xMin:t,xMax:e,yMin:o,yMax:r,zoom:n,altitude:i,rotationZ:s}=v,a=.5*(t+e),u=.5*(o+r),y=Math.sin(s)*n,l=-Math.cos(s)*n;I.position.set(a+y,u+l,i),I.lookAt(a,u,0),I.updateProjectionMatrix()}function V(){d.setTransform(1,0,0,1,0,0),d.clearRect(0,0,w.width,w.height),w.width*.5,w.height*.5,d.strokeStyle="#000",d.lineWidth=1;const{xMin:t,xMax:e,yMin:o,yMax:r}=v;for(let n=Math.ceil(t);n<=e;n++){const{px:i}=F(n,0);d.beginPath(),d.moveTo(i,0),d.lineTo(i,w.height),d.stroke()}for(let n=Math.ceil(o);n<=r;n++){const{py:i}=F(0,n);d.beginPath(),d.moveTo(0,i),d.lineTo(w.width,i),d.stroke()}d.fillStyle="rgba(255,0,0,0.1)",d.strokeStyle="red",M.forEach(n=>{d.beginPath(),n.points.forEach((i,s)=>{const{px:a,py:u}=F(i.x,i.y);s===0?d.moveTo(a,u):d.lineTo(a,u)}),d.closePath(),d.fill(),d.stroke()}),W&&C.length&&(d.strokeStyle="#00f",d.fillStyle="#00f",d.beginPath(),C.forEach((n,i)=>{const{px:s,py:a}=F(n.x,n.y);i===0?d.moveTo(s,a):d.lineTo(s,a)}),d.stroke(),C.forEach(n=>{const{px:i,py:s}=F(n.x,n.y);d.beginPath(),d.arc(i,s,3,0,Math.PI*2),d.fill()})),G&&G.length&&(d.strokeStyle="red",d.lineWidth=2,d.beginPath(),G.forEach((n,i)=>{const{px:s,py:a}=F(n.x,n.y);i===0?d.moveTo(s,a):d.lineTo(s,a)}),d.closePath(),d.stroke()),P&&P.length&&(d.strokeStyle="red",d.lineWidth=2,d.beginPath(),P.forEach((n,i)=>{const{px:s,py:a}=F(n.x,n.y);i?d.lineTo(s,a):d.moveTo(s,a)}),d.closePath(),d.stroke())}w.addEventListener("click",t=>{const{px:e,py:o}=St(t),r=qt(e,o);if(W){const n=C[0],i=F(n.x,n.y);if(C.length>=3&&Nt({px:e,py:o},i)<25){const{mesh:s,halfspaces:a}=Yt(C);M.push({points:C.slice(),mesh:s,halfspaces:a}),O.push(...a),Z=bt(),D(),W=!1,C=[]}else C.push(r);V();return}for(let n=M.length-1;n>=0;n--)if(lt(r,M[n].points)){z.remove(M[n].mesh),M.splice(n,1)[0],O.length=0;for(const i of M)O.push(...i.halfspaces);Z=bt(),D(),V();return}W=!0,C=[r],V()});window.addEventListener("resize",V);R.domElement.addEventListener("click",$t,!1);function $t(t){if(B){S.visible=!1,E.visible=!0,m.active=!0,m.back=!0,m.startTime=performance.now();return}const e=R.domElement.getBoundingClientRect();j.x=(t.clientX-e.left)/e.width*2-1,j.y=-(t.clientY-e.top)/e.height*2+1,K.setFromCamera(j,I);const o=K.intersectObject(k,!1)[0];if(!o)return;const r=o.point.clone(),n=kt(Z,r.x,r.y);X=k.geometry.clone(),Xt(r,n),Ot(r,n),S.visible=!0,S.position.copy(r),E.visible=!1,G=null,B=!0}D();_();window.addEventListener("resize",()=>{I.aspect=window.innerWidth/window.innerHeight,I.updateProjectionMatrix(),R.setSize(window.innerWidth,window.innerHeight)});function ft(){const t=parseInt(getComputedStyle(A).width,10),e=Math.round(t*.15);A.style.top=e+"px",A.style.left=e+"px",w.width=t,w.height=t,V()}ft();window.addEventListener("resize",ft);window.addEventListener("mousemove",t=>{j.x=t.clientX/window.innerWidth*2-1,j.y=-(t.clientY/window.innerHeight)*2+1});new f.Clock;function Et(){if(requestAnimationFrame(Et),N&&(V(),N=!1),m.active){const t=Math.min((performance.now()-m.startTime)/(m.duration*1e3),1);{const e=k.geometry.attributes.position.array,o=m.back?m.endPos:m.startPos,r=m.back?m.startPos:m.endPos;for(let n=0;n<e.length;++n)e[n]=o[n]+t*(r[n]-o[n]);k.geometry.attributes.position.needsUpdate=!0}if(m.polys.forEach(({attr:e,start:o,end:r})=>{const n=e.array,i=m.back?r:o,s=m.back?o:r;for(let a=0;a<n.length;++a)n[a]=i[a]+t*(s[a]-i[a]);e.needsUpdate=!0}),m.overlay.forEach(({poly:e,start:o,end:r})=>{const n=m.back?r:o,i=m.back?o:r;for(let s=0;s<n.length;s+=2)e.points[s>>1].x=n[s]+t*(i[s]-n[s]),e.points[s>>1].y=n[s+1]+t*(i[s+1]-n[s+1])}),m.ball){const{start:e,end:o}=m.ball,r=m.back?o:e,n=m.back?e:o;P||(P=[]);for(let i=0;i<r.length;i+=2)P[i>>1]||(P[i>>1]={x:0,y:0}),P[i>>1].x=r[i]+t*(n[i]-r[i]),P[i>>1].y=r[i+1]+t*(n[i+1]-r[i+1])}N=!0,t===1&&(k.geometry.computeVertexNormals(),m.polys.forEach(({attr:e})=>{var o,r,n;return(n=(r=(o=e.mesh)==null?void 0:o.geometry)==null?void 0:r.computeVertexNormals)==null?void 0:n.call(r)}),m.active=!1,B=!m.back,E.visible=!B,S.visible=B,B||(P=null))}if(!B){K.setFromCamera(j,I);const t=k?K.intersectObject(k,!1)[0]:null;if(t){E.visible=!0;const e=t.point.clone().add(t.face.normal.clone().multiplyScalar(.02));E.position.copy(e);const o=kt(Z,t.point.x,t.point.y);G=Ct(t.point.x,t.point.y,o,244),N=!0}else E.visible=!1,G=null,N=!0}R.render(H,I)}Et();
